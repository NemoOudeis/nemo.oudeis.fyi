<!DOCTYPE html>
<html lang="en-us">
    <head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<meta name="og:site_name" content="Nemo Oudeis FYI">
		
		<meta name="description" content="Why is software code so damn hard to read? I argue it&#39;s tot because it&#39;s hard or because programming languages are stupid - it&#39;s because developers and tools don&#39;t make their intent explicit. Code doesn&#39;t read like a short story or a poem - but it should! So just make it explicit for god sake...">
		<meta property="og:description" content="Why is software code so damn hard to read? I argue it&#39;s tot because it&#39;s hard or because programming languages are stupid - it&#39;s because developers and tools don&#39;t make their intent explicit. Code doesn&#39;t read like a short story or a poem - but it should! So just make it explicit for god sake..." />
		<meta property="twitter:description" content="Why is software code so damn hard to read? I argue it&#39;s tot because it&#39;s hard or because programming languages are stupid - it&#39;s because developers and tools don&#39;t make their intent explicit. Code doesn&#39;t read like a short story or a poem - but it should! So just make it explicit for god sake..." />
		
		<title>Make It Explicit &middot; Nemo Oudeis FYI</title>
		<meta property="og:title" content="Make It Explicit &middot; Nemo Oudeis FYI" />
		<meta property="twitter:title" content="Make It Explicit &middot; Nemo Oudeis FYI" />
		
		<meta property="og:url"	content="http://nemo.oudeis.fyi/posts/make-it-explicit/" />
		<meta property="twitter:card " content="summery_large_image" />
		
		<meta property="og:type" content="article" />
		
		<meta property="og:image" content="http://nemo.oudeis.fyi/hidden-secret.jpg" />

		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/fonts.css">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Nemo Oudeis FYI</h2>
				</a>
				<ul>
    
    
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        Nemo Oudeis
        <br>
        <span>on&nbsp;</span><time datetime="2020-06-15 17:03:01 &#43;0900 JST">June 15, 2020</time>
</div>
		<h1 class="post-title">Make It Explicit</h1>
<div class="post-line"></div>

		

		<p>Recently I did some pair programming and code review with a developer, we added deep links into our Android application. All in all that's a pretty simple task.</p>
<p>During the cycles of code review and pairing I realized that I first recommended to use one technique during pair programming, just to argue against it in a later on in code review. That made me think - Do I have some type of split brain thing going on here? Why do I flip flop like that? ü§î</p>
<p>Let's look at code: The first version I saw (slightly modified) was this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">val</span> DEEPLINK_PATH = <span style="color:#e6db74">&#34;/deepLinkPath&#34;</span>
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">val</span> DEEPLINK_SHEMA = <span style="color:#e6db74">&#34;deeplink-schema&#34;</span>

<span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">handleDeeplink</span>(intent: Intent?) {
    intent<span style="color:#f92672">?.</span>action<span style="color:#f92672">?.</span>let { action -&gt;
        intent.<span style="color:#66d9ef">data</span><span style="color:#f92672">?.</span>let { <span style="color:#66d9ef">data</span> -&gt;
            <span style="color:#66d9ef">if</span> (action == Intent.ACTION_VIEW) {
                <span style="color:#66d9ef">if</span> (DEEPLINK_SCHEMA == <span style="color:#66d9ef">data</span>.scheme) {
                    <span style="color:#66d9ef">if</span> (DEEPLINK_PATH == <span style="color:#66d9ef">data</span>.path) {
                        <span style="color:#66d9ef">data</span>.path<span style="color:#f92672">?.</span>let { path -&gt;
                            println(<span style="color:#e6db74">&#34;do the thing!&#34;</span>)
                        }
                    }
                }
            }
        }
    }
}
</code></pre></div><p>Well this is overly complicated, if I would put it into plain language it would be:</p>
<blockquote>
<p>I look at the intent<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, if it's not null, if it has an action, if it has data, and the action is <code>ACTION_VIEW</code> and the data has the URL schema that I expect and if it has the path that I expect, if the path is not null, then I <em>do the thing</em>.</p>
</blockquote>
<p><img src="/wut.png" alt="What did you just say?!"></p>
<p>Wait what? Huh?</p>
<p>Nobody wants to hear that. If I say that to you then your ears will start bleeding.</p>
<p>Not to speak of the indentation, it's horribly hard to read. This piece of code goes to great efforts to <em>conceal</em> its intent!</p>
<p>I suggested to simplify the conditionals and remove that indentation by introducing bouncer-style if checks. Moreover there's a design issue here that we conflate 2 concerns: (1) adapter code that translates between framework and our logic and (2) our own logic, which should be independent of Android specifics (like <code>Fragment</code>s, <code>Activity</code>s and <code>Intent</code>s).</p>
<p>My guy split the concerns and added the bouncer code, resulting in the below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">val</span> DEEPLINK_HOST = <span style="color:#e6db74">&#34;our.deeplink.host.fyi&#34;</span>
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">val</span> DEEPLINK_SCHEMA = <span style="color:#e6db74">&#34;deeplink-schema&#34;</span>
<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">val</span> DEEPLINK_PATH = <span style="color:#e6db74">&#34;/deepLinkPath&#34;</span>

<span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">handleDeepLink</span>(uri: Uri) {
    <span style="color:#66d9ef">val</span> schema: String? = uri.scheme <span style="color:#f92672">?:</span> <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">if</span> (schema != DEEPLINK_SCHEMA) {
        <span style="color:#66d9ef">return</span>
    }

    <span style="color:#75715e">// Safety check for host
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> host: String = uri.host <span style="color:#f92672">?:</span> <span style="color:#66d9ef">return</span>
    <span style="color:#66d9ef">if</span> (host != DEEPLINK_HOST) {
        <span style="color:#66d9ef">return</span>
    }

    <span style="color:#75715e">// Safety check for path
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> path: String = uri.path <span style="color:#f92672">?:</span> <span style="color:#66d9ef">return</span>

    <span style="color:#66d9ef">if</span> (path == DEEPLINK_PATH) {
        println(<span style="color:#e6db74">&#34;do the thing!&#34;</span>)
    }
}
</code></pre></div><p>Now that's a lot easier to read, the indentation is essentially flat (ignoring the bouncer <code>return</code> statements) and we actually do a couple of more checks. Note also that the adapter code of checking if the <code>Intent</code>'s nullability and if it has the correct action is not here (that's handled in the adapter layer as it should be).</p>
<p>But reading this I think: isn't that a bit verbose for the simple checks we do? Can't we reduce this to just a single conditional? Wouldn't that be more explicit?</p>
<p>So we arrive at:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin"><span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">handleDeepLink</span>(uri: Uri) {
    <span style="color:#66d9ef">if</span> (uri.scheme == DEEPLINK_SCHEMA &amp;&amp;
        uri.host == DEEPLINK_HOST &amp;&amp;
        uri.path === DEEPLINK_PATH
    ) {
        println(<span style="color:#e6db74">&#34;do the thing!&#34;</span>)
    }
}
</code></pre></div><p>This is the final version, which is arguably <strong>more explicit</strong> and <strong>less complex</strong> than both previous iterations. In normal language:</p>
<blockquote>
<p>If the URI has our deep link schema, host and path we <em>do the thing</em>.</p>
</blockquote>
<p>Now that's a sentence! You hear it &ndash; you get it. That's what the code should be like.</p>
<p>But I did tell my guy to</p>
<ol>
<li>Add bouncer code because it will make the code cleaner</li>
<li>Remove bouncer code because it will make the code cleaner</li>
</ol>
<p>ü§¶‚Äç‚ôÄÔ∏è</p>
<p>The poor guy must be thinking I enjoy making him jump through hoops to appease my sense of aesthetics. And I can see why he would get that idea&hellip;</p>
<p>Underlying this is more than a pattern, a technique, a specific design or a trick: I want the code to be explicit. All code should be explicit. This is such a universal guideline for me that I think it's a &hellip; <em>*drumroll*</em></p>
<h2 id="software-development-principle2">Software Development Principle<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></h2>
<p>Style, taste and aesthetics are too subjective for my taste, so let's define a <strong>software development principle</strong> that I use to guide my decision making. Rather than detailed prescriptive solutions (&ldquo;use bouncer code&rdquo;, &ldquo;use strategy pattern&rdquo;) is a high level rules that I instill in my development teams.</p>
<blockquote>
<p><strong>Principle</strong>: a basic idea or rule that explains or controls how something happens or works</p>
<p>&ndash; <a href="https://dictionary.cambridge.org/dictionary/english/principle">Cambridge Dictionary</a></p>
</blockquote>
<p>Something fancy like that ‚òùÔ∏è.</p>
<p>So get ready for&hellip;</p>
<h2 id="principle-1-make-it-explicit">Principle #1: Make it Explicit</h2>
<p>Now this may sound basic at first glance, but bear with me.</p>
<blockquote>
<p>Any fool can write code that a computer can understand. Good programmers write code that humans can understand.</p>
<p>&ndash; <a href="https://learning.oreilly.com/library/view/refactoring-improving-the/9780134757681/">Martin Fowler, 1999</a></p>
</blockquote>
<p><strong>Programming is communication with other programers. Therefore we have to strive to explicitly communicate the intent of our software.</strong></p>
<p>Code should read like a story to the (to a reasonable extent) initiated reader.</p>
<p>Kent Beck recognizes that in his <a href="https://martinfowler.com/bliki/BeckDesignRules.html">rules of simple design</a>:</p>
<blockquote>
<ul>
<li>Passes the tests</li>
<li><strong>Reveals intention</strong></li>
<li>No duplication</li>
<li>Fewest elements</li>
</ul>
</blockquote>
<p>So if that's all over 20 years old, surely we all do this already, right? I wish&hellip;.</p>
<p>Let me walk you though a couple cases I encountered &ldquo;in the real world&quot;‚Ñ¢Ô∏è, examples in which the code was less than explicit about its intent.</p>
<h3 id="example-1-web-frameworks">Example #1: Web Frameworks</h3>
<p>Spring is a <del>decent</del> web framework, it has a lot of features and many people use it. Still I dislike Spring for the single reason that they make it damn hard to know what's going on! The significant code, the one that actually implements your business logic that &ndash; you know, makes all the money &ndash; is buried in a pile of annotations. This is only partially spring's fault, you don't <em>have</em> to do it way. But in reality I see code bases doing it that way. Here is an adapted example of some real java code that someone (with far more Spring experience than me) has written:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@RestController</span>
<span style="color:#a6e22e">@Api</span>
<span style="color:#a6e22e">@Validated</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AnExampleController</span> <span style="color:#f92672">{</span>

  <span style="color:#a6e22e">@Autowired</span>
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AnExampleController</span><span style="color:#f92672">(</span>AnExampleService exampleService<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">exampleService</span> <span style="color:#f92672">=</span> exampleService<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@ApiOperation</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Get Example&#34;</span><span style="color:#f92672">,</span> response <span style="color:#f92672">=</span> ExampleResponse<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
  <span style="color:#a6e22e">@ApiResponses</span><span style="color:#f92672">(</span>
      value <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
          <span style="color:#a6e22e">@ApiResponse</span><span style="color:#f92672">(</span>code <span style="color:#f92672">=</span> 200<span style="color:#f92672">,</span> message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Success&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span>
          <span style="color:#a6e22e">@ApiResponse</span><span style="color:#f92672">(</span>code <span style="color:#f92672">=</span> 400<span style="color:#f92672">,</span> message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Bad Request&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span>
          <span style="color:#a6e22e">@ApiResponse</span><span style="color:#f92672">(</span>code <span style="color:#f92672">=</span> 500<span style="color:#f92672">,</span> message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Internal Server Error&#34;</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">}</span><span style="color:#f92672">)</span>
  <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;example&#34;</span><span style="color:#f92672">)</span>
  <span style="color:#66d9ef">public</span> ResponseEntity <span style="color:#a6e22e">getExample</span><span style="color:#f92672">(</span>
      <span style="color:#a6e22e">@RequestHeader</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;subject&#34;</span><span style="color:#f92672">)</span> String subject<span style="color:#f92672">,</span>
      <span style="color:#a6e22e">@RequestHeader</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;alternativeSubject&#34;</span><span style="color:#f92672">,</span> required <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span>
      String alternativeSubject
  <span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// Do the thing
</span><span style="color:#75715e"></span>    exampleService<span style="color:#f92672">.</span><span style="color:#a6e22e">doTheThing</span><span style="color:#f92672">(</span>subject<span style="color:#f92672">,</span> alternativeSubject<span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>That's 12 annotations and 23 lines of code <strong>before you get to the point</strong>. That is not explicit, that's the opposite.</p>
<p>Similarly the data driven test code for class (this time in Kotlin) is a mess:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-kotlin" data-lang="kotlin">@SpringBootTest(classes = [ExampleApplication<span style="color:#f92672">::</span><span style="color:#66d9ef">class</span>])
@WebAppConfiguration
@RunWith(Parameterized<span style="color:#f92672">::</span><span style="color:#66d9ef">class</span>)
@Suppress(<span style="color:#e6db74">&#34;UNUSED_PARAMETER&#34;</span>)
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExampleParameterizedTest</span>(
    <span style="color:#75715e">/* parameters */</span>
) {

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">var</span> mockMvc: MockMvc? = <span style="color:#66d9ef">null</span>

    @Autowired
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">val</span> wac: WebApplicationContext? = <span style="color:#66d9ef">null</span>

    @MockBean
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">lateinit</span> <span style="color:#66d9ef">var</span> exampleService: ExampleService

    @get:Rule
    <span style="color:#66d9ef">val</span> springMethodRule = SpringMethodRule()

    @Before
    <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">setup</span>() {
        mockMvc = MockMvcBuilders.webAppContextSetup(wac<span style="color:#f92672">!!</span>).build()
    }

    @Test
    @Throws(Exception<span style="color:#f92672">::</span><span style="color:#66d9ef">class</span>)
    @MethodSource(<span style="color:#e6db74">&#34;exampleParameters&#34;</span>)
    <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">someTestMethod</span>() {
        <span style="color:#75715e">// Do the test
</span><span style="color:#75715e"></span>    }

    <span style="color:#66d9ef">companion</span> <span style="color:#66d9ef">object</span> {

        @ClassRule
        @JvmField
        <span style="color:#66d9ef">var</span> SPRING_CLASS_RULE = SpringClassRule()

        @JvmStatic
        @Parameterized.Parameters
        <span style="color:#66d9ef">fun</span> <span style="color:#a6e22e">exampleParameters</span>() = listOf(<span style="color:#75715e">/* test data */</span>)
    }
}
</code></pre></div><p>All the effort you have to put in just to write a test&hellip; and slow running complex ones at that. I don't think we have to dive into the details here.</p>
<p>Ok so if Spring somehow makes people write hard to read code, what are some other options?</p>
<p>ü§î</p>
<p>How about Node.js + Express? Let's look at another adapted real world example (again authored by somebody who is a more experienced express programmer than me):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// app.js
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">express</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;express&#39;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">express</span>();

<span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">use</span>(<span style="color:#e6db74">&#39;/example&#39;</span>, <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;./example-controller&#39;</span>))

<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">app</span>;

<span style="color:#75715e">// example-controller.js
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">router</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;express&#39;</span>).<span style="color:#a6e22e">Router</span>();
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">service</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;./example-service&#39;</span>);

<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/&#39;</span>, <span style="color:#a6e22e">async</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">subject</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;subject&#39;</span>)
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">alternativeSubject</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;alternativeSubject&#39;</span>)
    <span style="color:#75715e">// Do the thing
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">doTheThing</span>(<span style="color:#a6e22e">subject</span>, <span style="color:#a6e22e">alternativeSubject</span>)
});

<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">router</span>

<span style="color:#75715e">// tests/example-controller.test.js
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">request</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;supertest&#39;</span>);
<span style="color:#a6e22e">jest</span>.<span style="color:#a6e22e">mock</span>(<span style="color:#e6db74">&#39;../example-service&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;../app&#39;</span>); <span style="color:#75715e">// the app file above
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">describe</span>(<span style="color:#e6db74">&#39;The example controllor&#39;</span>, () =&gt; {
    <span style="color:#a6e22e">test</span>.<span style="color:#a6e22e">each</span>([<span style="color:#75715e">/* test data */</span>], (<span style="color:#75715e">/* parameters*/</span>) =&gt; {
        <span style="color:#a6e22e">request</span>(<span style="color:#a6e22e">app</span>) <span style="color:#75715e">// do the test
</span><span style="color:#75715e"></span>    })
})
</code></pre></div><p>Now this does most what the above Spring code does. In about half the amount of code. So express definitely facilitates more concise code. And I argue that just by that fact it already is more explicit that the Spring example. Nothing is buried in boilerplate here. Sure you may not know all the details of the <code>Router</code> or of the <code>supertest</code> package, but that is equally true for Spring's <code>WebApplicationContext</code> or the <code>@Validated</code> annotation. That's totally fine, explicit doesn't need to be verbose. We don't know all the things, that's why we read documentation.</p>
<p>What I'm getting at is that the express example explicitly communicates its intent. The spring example does not.</p>
<p>We could have done the same exercise with <a href="https://ktor.io/">ktor</a>, <a href="http://sinatrarb.com/">sinatra</a>, <a href="https://github.com/pallets/flask">flask</a>, <a href="https://rubyonrails.org/">rails</a>, etc. In this case the problem is not Java (although in many other cases it is) and even the spring project itself is trying to dig itself out of that hole with <a href="https://github.com/spring-projects-experimental/spring-fu/tree/master/kofu">spring fu</a>.</p>
<p>Rails advertises and delivers convention over configuration.
As a result the average rails codebase is more readable and communicates intent better than the average spring codebase.</p>
<p>Spring on the other hand often ends up in the &ldquo;obfuscation over convention&rdquo; corner.</p>
<h3 id="example-2-generic-jenkins-cd-pipeline">Example #2: Generic Jenkins CD Pipeline</h3>
<p>Here's Another real world example from a team that operates k8s clusters as a service for application teams. They have different environments (development, staging and production) and provide a Jenkins job to deploy to each of them, i.e. 3 jobs.
They decided to use a single Jenkins pipeline for all jobs and hardcode the credentials specific for each environment in the job config, for example the job deploying to staging environment has the <code>env = 'stg'</code> parameter hardwired in Jenkins web UI.</p>
<p>Here's the conditional logic of that pipeline, without the actual operations in each stage:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#75715e">// Jenkinsfile
</span><span style="color:#75715e"></span>pipeline <span style="color:#f92672">{</span>
  parameters <span style="color:#f92672">{</span>
    choice<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;action&#39;</span><span style="color:#f92672">,</span> choices: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;deploy&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;delete&#39;</span><span style="color:#f92672">]</span><span style="color:#f92672">)</span>
    choice<span style="color:#f92672">(</span>name: <span style="color:#e6db74">&#39;env&#39;</span><span style="color:#f92672">,</span> choices: <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;dev&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;stg&#39;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#39;prod&#39;</span><span style="color:#f92672">]</span><span style="color:#f92672">)</span>
  <span style="color:#f92672">}</span>
  stages <span style="color:#f92672">{</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;init&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;build app&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      when <span style="color:#f92672">{</span>
        expression <span style="color:#f92672">{</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">env</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;dev&#39;</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">action</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;deploy&#39;</span> <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;build docker image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      when <span style="color:#f92672">{</span>
        expression <span style="color:#f92672">{</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">env</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;dev&#39;</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">action</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;deploy&#39;</span> <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;select container image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      when <span style="color:#f92672">{</span>
        expression <span style="color:#f92672">{</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">env</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;dev&#39;</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">action</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;deploy&#39;</span> <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;promote container image to next env&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      when <span style="color:#f92672">{</span>
        expression <span style="color:#f92672">{</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">env</span> <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;dev&#39;</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">action</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;deploy&#39;</span> <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy to k8s&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;monitor rollout status&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      when <span style="color:#f92672">{</span>
        expression <span style="color:#f92672">{</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">action</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;deploy&#39;</span> <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;release notes&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      when <span style="color:#f92672">{</span>
        expression <span style="color:#f92672">{</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">action</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;deploy&#39;</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">env</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;prod&#39;</span> <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;notify slack&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      when <span style="color:#f92672">{</span>
        expression <span style="color:#f92672">{</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">action</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;deploy&#39;</span> <span style="color:#f92672">&amp;</span><span style="color:#f92672">&amp;</span> params<span style="color:#f92672">.</span><span style="color:#a6e22e">env</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;prod&#39;</span> <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&hellip;now: tell me what stages run for <code>action = deploy</code> and <code>env = dev</code>? Can you tell? I can't, not without wasting effort untangling the mess. This pipeline obfuscates intent and control flow.</p>
<p>So my team split up the pipeline into 3, one for each environment:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-groovy" data-lang="groovy"><span style="color:#75715e">// develop.jenkinsfile
</span><span style="color:#75715e"></span>pipeline <span style="color:#f92672">{</span>
  stages <span style="color:#f92672">{</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;init&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;build app&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;build docker image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy to k8s&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;monitor rollout status&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// staging.jenkinsfile
</span><span style="color:#75715e"></span>pipeline <span style="color:#f92672">{</span>
  stages <span style="color:#f92672">{</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;init&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;select container image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;promote container image to next env&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy to k8s&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;monitor rollout status&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// production.jenkinsfile
</span><span style="color:#75715e"></span>pipeline <span style="color:#f92672">{</span>
  stages <span style="color:#f92672">{</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;init&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;select container image&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;promote container image to next env&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;deploy to k8s&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;monitor rollout status&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;release notes&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
    stage<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;notify slack&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Now let me ask again: which stages run when we deploy to the development environment? Pretty obvious now, because there are no more conditionals in any of the pipelines! Isn't that much more explicit?</p>
<p>Ok, but that's maybe not perfect, there are some concerns you might raise</p>
<ol>
<li>These pipelines are not equivalent to the previous above, the <code>action = 'delete'</code> cases are missing ‚Üí We never used that - but we had no idea, because that was buried in the complexity of the previous pipeline. The code did not tell us, that was its little dirty secret.</li>
<li>There is of duplication in the pipeline we use for production &amp; staging ‚Üí Yes that is true. But we value explicit separation of these concerns is more over reusing code in this case. It is a trade off: simplicity vs no-duplication. Simplicity, I chose you!</li>
</ol>
<p>See how something interesting happened there? Because we follow a this principle of &ldquo;Make It Explicit!&rdquo; we are empowered to violate the programmer common sense of &ldquo;duplication is bad!&quot;.</p>
<p>Similarly following the principle lead us to identify a design problem: the pipeline clearly had multiple reasons to change, in other words: multiple responsibilities. By following our plan to make the code more explicit we also applied the single responsibility principle, without even thinking about it.</p>
<p>I have more examples of code that obfuscates intent, code that needs to be more explicit - but I think you get the point.</p>
<h2 id="what-is-it-good-for">What is It Good for?</h2>
<p>In summary: a lot of code is damn hard to read. Not because of programming languages or frameworks. Because programmers follow rules of thumb (reuse everything always, use annotations instead of code, etc.) without asking themselves: <strong>is this in line with my/our development principles</strong>? This is the first of the principles me and my teams follow, I'll write about the other ones in following posts - here's a shortlist:</p>
<ul>
<li>Make it Explicit</li>
<li>Business Drives IT</li>
<li>Don't build Software</li>
<li>Trade-Offs &amp; Decisions</li>
<li>Simple over Easy</li>
</ul>
<p>This is a work in progress, non-exhaustive and specific to my professional environment &ndash; but it's what I've got so for üòÑ. Let me know how principles affect your design &amp; development and about your principles - maybe I'll steal some&hellip;</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><code>Intent</code> is an Android framework class, you can think of it as a value object that carries the intent of a message the operating system sent to your application. For example when the application launches or when the operating system sends a broadcast to your applications with updates of the battery level. <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>I went back and forth between &ldquo;principle&rdquo; and &ldquo;directive&rdquo;. Directive sounds less lofty and one definition is <a href="https://www.merriam-webster.com/dictionary/directive">&ldquo;something that serves to direct, guide, and usually impel toward an action or goal&rdquo;</a>. Which is what I am talking about, kind of. But for the time being let's stick with principle. <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>


		
	</div>

	<div class="pagination">
		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2020-08-02 00:15:56.423882 &#43;0900 JST m=&#43;0.374643821">2020</time> Nemo Oudeis
			</span>
		</footer>

    </body>
</html>
